<template>
  <div class="projectsetup">
    <Navigation/>

    <vue-good-table :columns="columns" :rows="gitlabProjects" :pagination-options="{ enabled: true, perPage: 10}" :search-options="{ enabled: true}" styleClass="vgt-table striped bordered" @on-row-click="onRowClick">
    </vue-good-table>
    <button @click="showCreateProjectModal()">Create new</button>

    <Modal v-model="createProjectModal.show" title="Create Project">
      <p>
        Do you want to create a DebugChain project for this GitLab project?<br />
      </p>
      <div class="alert alert-primary">
        <label>ID: <input type="text" class="form-control" v-model="createProjectModal.id" /></label>
        <label>URL <input type="text" class="form-control" v-model="createProjectModal.url"/></label>
      </div>

      <template slot="footer">
        <button type="button" class="btn btn-primary" @click="createProjectModalSave()">Save</button>
        <button type="button" class="btn btn-secondary" @click="closeCreateProjectModal()">Close</button>
      </template>
    </Modal>
  </div>

</template>


<script>
import Gitlab from "@/api/gitlab";
import Modal from "@/components/Modal.vue";
import Navigation from "@/components/Navigation";
import getWeb3 from "@/api/getWeb3"
//import appContract from "@/api/initContract"
import debugchainJson from '../../abi/___contracts_contracts_DebugChain_sol_DebugChain';
//const debugchainJson from '../../abi/___contracts_contracts_DebugChain_sol_DebugChain.json';

var App = {

  contracts: {},

  registerWeb3 () {
      console.log('registerWeb3 Action being executed')
      getWeb3.then(result => {
        console.log('committing result to registerWeb3Instance mutation')

      }).catch(e => {
        console.log('error in action registerWeb3', e)
      })
    },

  initContract: function() {
    var debugchainContract = null;
    console.log("initContract");
    console.log("create debugchain Contract:");
    console.log(debugchainJson);
    App.registerWeb3();
    debugchainContract = web3.eth.contract(debugchainJson);
    console.log(debugchainContract);
    return debugchainContract;
  }
}
export default {
  name: "projectList",
  components: {
    Modal,
    Navigation
  },
  data: function() {
    return {
      createProjectModal: {
        show: false,
        id: 0,
        url: ""
      },
      columns: [
        {
          label: "ID",
          field: "id",
          type: "number"
        },
        {
          label: "Maintainer",
          field: "owner"
        },
        {
          label: "URL",
          field: "url"
        }
      ],
      gitlabProjects: []
    };
  },
  created: function() {
    this.updateData();
  },
  
  methods: {
    createProjectModalSave: function(){
      this.createProject(this.createProjectModal.id, this.createProjectModal.url);
    },

    createProject: function(id, url) {
      console.log("create project called with ID / url:");
      console.log(this.createProjectModal.id);
      console.log(this.createProjectModal.url);
      //TODO meta mask + backend calls
      //App.registerWeb3();
      var debugchainContract = App.initContract();
      //var accounts = web3.eth.accounts;
      //console.log(accounts);
      var debugchainContractDeployed = debugchainContract.new(
         id,
         {
              from: web3.eth.accounts[0],
              data: '0x6060604052341561000f57600080fd5b604051602080610f4c8339810160405280805190602001909190505033600160006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff1602179055508060008190555050610ec9806100836000396000f3006060604052600436106100af576000357c0100000000000000000000000000000000000000000000000000000000900463ffffffff16806302afb4b4146100b457806318e5df5f1461012c5780633ccfd60b1461014f578063519d4a82146101645780637a276bb6146101c7578063976b31131461022a578063a0769ad7146102bb578063aa1e9e43146102de578063d5a534e914610301578063f14faf6f14610343578063f340c0d01461035b575b600080fd5b34156100bf57600080fd5b6100d560048080359060200190919050506103a8565b6040518080602001828103825283818151815260200191508051906020019060200280838360005b838110156101185780820151818401526020810190506100fd565b505050509050019250505060405180910390f35b341561013757600080fd5b61014d6004808035906020019091905050610483565b005b341561015a57600080fd5b610162610678565b005b341561016f57600080fd5b6101c5600480803590602001909190803590602001908201803590602001908080602002602001604051908101604052809392919081815260200183836020028082843782019150505050505091905050610744565b005b34156101d257600080fd5b6101e860048080359060200190919050506107a4565b604051808273ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200191505060405180910390f35b341561023557600080fd5b61024b6004808035906020019091905050610815565b604051808581526020018481526020018060200183151515158152602001828103825284818151815260200191508051906020019060200280838360005b838110156102a4578082015181840152602081019050610289565b505050509050019550505050505060405180910390f35b34156102c657600080fd5b6102dc6004808035906020019091905050610952565b005b34156102e957600080fd5b6102ff6004808035906020019091905050610a75565b005b341561030c57600080fd5b610341600480803590602001909190803573ffffffffffffffffffffffffffffffffffffffff16906020019091905050610aa9565b005b6103596004808035906020019091905050610b33565b005b341561036657600080fd5b610392600480803573ffffffffffffffffffffffffffffffffffffffff16906020019091905050610c62565b6040518082815260200191505060405180910390f35b6103b0610cab565b816002600082815260200190815260200160002060070160019054906101000a900460ff1615156103e057600080fd5b6002600084815260200190815260200160002060040180548060200260200160405190810160405280929190818152602001828054801561047657602002820191906000526020600020905b8160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001906001019080831161042c575b5050505050915050919050565b61048b610cbf565b6002600083815260200190815260200160002060070160019054906101000a900460ff161515156104bb57600080fd5b6101206040519081016040528083815260200160008152602001600073ffffffffffffffffffffffffffffffffffffffff16815260200160006040518059106105015750595b908082528060200260200182016040525081526020016000151581526020016000151581526020016000151581526020016000151581526020016001151581525090508060026000848152602001908152602001600020600082015181600001556020820151816002015560408201518160030160006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff16021790555060608201518160040190805190602001906105cf929190610d32565b5060808201518160050160006101000a81548160ff02191690831515021790555060a08201518160050160016101000a81548160ff02191690831515021790555060c08201518160050160026101000a81548160ff02191690831515021790555060e08201518160070160006101000a81548160ff0219169083151502179055506101008201518160070160016101000a81548160ff0219169083151502179055509050505050565b6000600360003373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020016000205490506000600360003373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020819055503373ffffffffffffffffffffffffffffffffffffffff166108fc829081150290604051600060405180830381858888f19350505050151561074157600080fd5b50565b816002600082815260200190815260200160002060070160019054906101000a900460ff16151561077457600080fd5b8160026000858152602001908152602001600020600401908051906020019061079e929190610dbc565b50505050565b6000816002600082815260200190815260200160002060070160019054906101000a900460ff1615156107d657600080fd5b6002600084815260200190815260200160002060030160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff16915050919050565b600080610820610cab565b6000846002600082815260200190815260200160002060070160019054906101000a900460ff16151561085257600080fd5b6002600087815260200190815260200160002060000154600260008881526020019081526020016000206002015460026000898152602001908152602001600020600401600260008a815260200190815260200160002060070160009054906101000a900460ff168180548060200260200160405190810160405280929190818152602001828054801561093b57602002820191906000526020600020905b8160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190600101908083116108f1575b505050505091509450945094509450509193509193565b806002600082815260200190815260200160002060070160019054906101000a900460ff16151561098257600080fd5b600260008381526020019081526020016000206002015460036000600160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020016000208190555060016002600084815260200190815260200160002060070160006101000a81548160ff021916908315150217905550813373ffffffffffffffffffffffffffffffffffffffff167f824d3fc08790b56a237949423fc3b19100430c4ca2c8ec1bfcbe3e5e7557d0b760405160405180910390a35050565b806002600082815260200190815260200160002060070160019054906101000a900460ff161515610aa557600080fd5b5050565b816002600082815260200190815260200160002060070160019054906101000a900460ff161515610ad957600080fd5b816002600085815260200190815260200160002060030160006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff160217905550505050565b806002600082815260200190815260200160002060070160019054906101000a900460ff161515610b6357600080fd5b6002600083815260200190815260200160002060070160009054906101000a900460ff16151515610b9357600080fd5b346002600084815260200190815260200160002060010160003373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002081905550346002600084815260200190815260200160002060020160008282540192505081905550813373ffffffffffffffffffffffffffffffffffffffff167f53d9dd1ed867358e4fa3218d34eda1a3280dbf3d40fc4a742967b16d49db9840346040518082815260200191505060405180910390a35050565b6000600360008373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020549050919050565b602060405190810160405280600081525090565b610120604051908101604052806000815260200160008152602001600073ffffffffffffffffffffffffffffffffffffffff168152602001610cff610e46565b81526020016000151581526020016000151581526020016000151581526020016000151581526020016000151581525090565b828054828255906000526020600020908101928215610dab579160200282015b82811115610daa5782518260006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff16021790555091602001919060010190610d52565b5b509050610db89190610e5a565b5090565b828054828255906000526020600020908101928215610e35579160200282015b82811115610e345782518260006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff16021790555091602001919060010190610ddc565b5b509050610e429190610e5a565b5090565b602060405190810160405280600081525090565b610e9a91905b80821115610e9657600081816101000a81549073ffffffffffffffffffffffffffffffffffffffff021916905550600101610e60565b5090565b905600a165627a7a723058205d2e8400df43f85a402f04600408ad9734e6eeb3b9d1dd886b7622974c094fc50029',
              gas: '4700000'
         }, function (e, contract){
                console.log(e, contract);
                if (typeof contract.address !== 'undefined') {
                     console.log('Contract mined! address: ' + contract.address + ' transactionHash: ' + contract.transactionHash);
                }
            }
      );
      console.log(debugchainContractDeployed);

    },
    setProjects: function(newProjects) {
      this.gitlabProjects = newProjects.map(project => {
        return {
          id: project.id,
          url: project.web_url,
          owner: project.owner.username
        };
      });
    },
    updateData: function() {
      const client = Gitlab.getClient();
      const that = this;
      client.projects.list().then(projects => {
        that.setProjects(projects);
      });
    },
    showCreateProjectModal: function(params) {
      this.createProjectModal.show = true;
    },
    closeCreateProjectModal: function() {
      this.createProjectModal.show = false;
      this.createProjectModal.address = 0;
      this.createProjectModal.id = "";
    },
    openProject: function(id) {
      // TODO see if project already exists in our system,
      //   open its issue table if yes,
      //   else
      //   open Modal to create new project
      this.$router.push({
        name: "issueList",
        params: { projectId: id.toString() }
      });
    },
    onRowClick: function(params) {
      this.openProject(params.row.id);
    }
  }
};
</script>